<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpenSockit FPS Demo</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js';
import opensockit from 'https://opensockit.onrender.com/opensockit.js';

const sockit = new opensockit();
await sockit.connect();

console.log('Connected to OpenSockit!');

// --- Scene Setup ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.y = 2;
camera.position.z = 5;

const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// --- Player ---
const players = {}; // userId -> mesh
const playerGeometry = new THREE.BoxGeometry(1, 2, 1);
const playerMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });

// --- Ground ---
const groundGeo = new THREE.PlaneGeometry(100, 100);
const groundMat = new THREE.MeshStandardMaterial({ color: 0x228B22 });
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// --- Light ---
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10, 10, 10);
scene.add(light);

// --- Input ---
const keys = {};
document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

let playerId = null;
sockit.getSocket().on('userConnected', id => {
  players[id] = new THREE.Mesh(playerGeometry, playerMaterial.clone());
  players[id].material.color.setHex(Math.random() * 0xffffff);
  scene.add(players[id]);
  console.log(`User ${id} connected`);
});

sockit.getSocket().on('userDisconnected', id => {
  if(players[id]) {
    scene.remove(players[id]);
    delete players[id];
  }
});

// Identify self
playerId = sockit.getSocket().id;
players[playerId] = new THREE.Mesh(playerGeometry, playerMaterial.clone());
players[playerId].material.color.setHex(0x0000ff);
scene.add(players[playerId]);

// --- Multiplayer Sync ---
sockit.getSocket().on('move', ({id, pos}) => {
  if(players[id]) players[id].position.set(pos.x, pos.y, pos.z);
});

sockit.getSocket().on('shoot', ({id, pos, dir}) => {
  createBullet(new THREE.Vector3(pos.x, pos.y, pos.z), new THREE.Vector3(dir.x, dir.y, dir.z));
});

// --- Bullets ---
const bullets = [];
function createBullet(pos, dir) {
  const geo = new THREE.SphereGeometry(0.1, 8, 8);
  const mat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
  const bullet = new THREE.Mesh(geo, mat);
  bullet.position.copy(pos);
  bullet.userData.dir = dir.clone().normalize().multiplyScalar(0.5);
  scene.add(bullet);
  bullets.push(bullet);
}

// --- Animate ---
function animate() {
  requestAnimationFrame(animate);

  // Player movement
  const speed = 0.1;
  if(keys['w']) players[playerId].position.z -= speed;
  if(keys['s']) players[playerId].position.z += speed;
  if(keys['a']) players[playerId].position.x -= speed;
  if(keys['d']) players[playerId].position.x += speed;

  // Send position to other clients
  sockit.send('move', { id: playerId, pos: players[playerId].position });

  // Update bullets
  bullets.forEach((b, i) => {
    b.position.add(b.userData.dir);
    if(Math.abs(b.position.x) > 50 || Math.abs(b.position.z) > 50) {
      scene.remove(b);
      bullets.splice(i, 1);
    }
  });

  camera.position.x = players[playerId].position.x;
  camera.position.z = players[playerId].position.z + 5;
  camera.lookAt(players[playerId].position);

  renderer.render(scene, camera);
}

animate();

// --- Shooting ---
document.addEventListener('click', () => {
  const dir = new THREE.Vector3(0, 0, -1);
  createBullet(players[playerId].position.clone(), dir);
  sockit.send('shoot', { id: playerId, pos: players[playerId].position, dir });
});

</script>
</body>
</html>
